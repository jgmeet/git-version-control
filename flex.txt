Finally adding changes from final branch.